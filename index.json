[{"uri":"https://johnxlivingston.github.io/campagnodon/","title":"Campagnodon","tags":[],"description":"","content":"Campagnodon Plugin SPIP pour la gestion des campagnes d\u0026rsquo;adhésions et de dons.\nPrésentation Systèmes distants Documentation fonctionnelle Documentation technique Limitations connues Glossaire "},{"uri":"https://johnxlivingston.github.io/campagnodon/presentation/","title":"Présentation","tags":[],"description":"","content":"Campagnodon est un Plugin SPIP pour la gestion des campagnes d\u0026rsquo;adhésions et de dons.\nCe plugin s\u0026rsquo;interface avec le plugin Bank, et propose des formulaires d\u0026rsquo;adhésions et de dons.\nCe plugin a été développé pour les besoins d\u0026rsquo;Attac France, en remplacement du plugin souscription.\nContrairement au plugin souscription, le stockage et le traitement des données personnelles se fait dans un système distant, pour des raisons de compartimentation et de sécurisation. Dans le cas d\u0026rsquo;Attac France, ces données sont stockées et traitées via une instance CiviCRM (non accessible publiquement).\nPour l\u0026rsquo;instant, le code est conçu pour répondre aux besoins d\u0026rsquo;Attac France, et est notamment lié à CiviCRM (voir la documentation). Toutefois, le code essaie d\u0026rsquo;être le plus générique possible, et fait en sorte d\u0026rsquo;être face à étendre.\nPour la liste des versions disponibles, merci de vous référer au fichier CHANGELOG.md présent dans le dépot.\n"},{"uri":"https://johnxlivingston.github.io/campagnodon/fonctionnel/campagnes/","title":"Campagnes","tags":[],"description":"","content":"Chaque don ou adhésion doit être associé à une campagne.\nLes campagnes sont à créer sur le système distant. Ici par exemple, les campagnes crées dans CiviCRM:\nCes campagnes sont ensuite synchronisées dans SPIP toutes les heures. On peut retrouver la liste des campagnes dans l\u0026rsquo;espace privé de SPIP, via le menu Activité \u0026gt; Campagnodon \u0026gt; Campagnes :\nSi vous ne voulez pas attendre que la synchronisation passe, vous pouvez la déclencher manuellement via le menu SPIP Maintenance \u0026gt; Liste des travaux, puis en cherchant la Tâche CRON campagnodon_synchronisation_campagnes (toutes les 3600 s). Il suffit alors de cliquer sur Exécuter maintenant.\nCampagnodon peut être lié à plusieurs systèmes distant différents. La colonne origine indique le nom du système distant concerné.\nSi la campagne a un objectif de dons dans le système distant, alors il sera possible d\u0026rsquo;afficher des bandeau d\u0026rsquo;avancement dans les articles ou en tête de site.\n"},{"uri":"https://johnxlivingston.github.io/campagnodon/presentation/fonctionnel/","title":"Fonctionnel","tags":[],"description":"","content":"Formulaires de dons et adhésion Le plugin SPIP Campagnodon permet d\u0026rsquo;inclure dans des articles SPIP des formulaires de dons ou d\u0026rsquo;adhésions:\nCes formulaires sont hautement configurables, aussi bien au niveau de l\u0026rsquo;installation complète, que article par article:\nchoix des montants proposés proposer les dons mensuels ou non proposer la saisie d\u0026rsquo;un don à montant libre on peut configurer et ajouter autant d\u0026rsquo;options «opt-in» que l\u0026rsquo;on veut Attention, Campagnodon ne gère pas la partie bancaire. Il vous faut utiliser le plugin SPIP Bank, et le configurer pour faire appel à un prestataire bancaire.\nSystème distant Les données personnelles ne sont pas stockées coté SPIP, elles sont envoyées dans un système distant, qui peut ne pas être accessible publiquement.\nCela permet de compartimenter et sécuriser les données.\nÀ l\u0026rsquo;origine, ce projet a été conçu avec une extension CiviCRM Campagnodon CiviCRM. Mais les API de communication entre ces deux systèmes sont standardisées, et il est possible de mettre d\u0026rsquo;autres systèmes en lieu et place de CiviCRM (à condition de développer les connecteurs adéquates).\nSi vous souhaitez utiliser Campagnodon avec autre chose que CiviCRM (ou même autre chose que SPIP), n\u0026rsquo;hésitez pas à contacter John Livingston. Vous pouvez par exemple passer par les gestionnaires de tickets de l\u0026rsquo;un des dépots de code référencé sur ce site web (voir dans le menu gauche).\nCiviCRM Coté CiviCRM, l\u0026rsquo;extension Campagnodon CiviCRM vient avec une application permettant de suivre les «transactions Campagnodon». Elle fourni également des API dédiées, qui permettent de:\ncréer des contributions créer ou prolonger des adhésions dédoublonner automatiquement les contacts gérer les options présentes dans le formulaire (par ex: accepter d\u0026rsquo;être démarché, être ajouté à des groupes, etc\u0026hellip;) On peut alors retrouver dans CiviCRM l\u0026rsquo;historique complet des données venant de Campagnodon.\nEt pour chaque transaction, son détail:\nle contact les données personnelles saisies les contributions crées les adhésions crées les groupes dans lesquels le contact a été ajouté \u0026hellip; "},{"uri":"https://johnxlivingston.github.io/campagnodon/distant/","title":"Systèmes distants","tags":[],"description":"","content":"Systèmes distants Campagnodon s\u0026rsquo;interface avec un (ou plusieurs) système(s) distant(s).\nCampagnodon est conçu de sorte à permettre de facilement changer le système distant dans lequel les données personnelles vont être stockées.\nLes données personnelles ne seront pas stockées sur le système d\u0026rsquo;origine (SPIP).\nÀ la date de rédaction de la présente page, Attac France se sert de Campagnodon avec CiviCRM en backend.\n"},{"uri":"https://johnxlivingston.github.io/campagnodon/fonctionnel/articles/","title":"Utilisation dans un article","tags":[],"description":"","content":"Pour insérer un formulaire de don et/ou d\u0026rsquo;adhésion dans un article, il suffit d\u0026rsquo;utiliser une balise \u0026lt;campagnodon\u0026gt; dans la rédaction de celui-ci. Il va falloir ajouter des attributs à cette balise, pour configurer le formulaire.\nPas de panique, Campagnodon fourni un utilitaire pour facilement générer la balise adéquate !\nGénérer la balise et ses attributs Commencez par vous rendre dans l\u0026rsquo;écran des campagnes : dans l\u0026rsquo;espace privé de SPIP, ouvrez le menu Activités \u0026gt; Campagnodon, puis dans le menu gauche sélectionnez campagnes :\nCliquez ensuite sur la campagne qui vous intéresse. Une fenêtre s\u0026rsquo;ouvre alors, reprennant les informations de base de la campagne, ainsi qu\u0026rsquo;un utilitaire pour générer la balise qui vous convient :\nSi vous cochez par exemple le bouton radio don:\nVous pouvez alors sélectionner et copier/coller la balise campagnodon affichée dans le champs en dessous.\nIci, on a :\n\u0026lt;campagnodon| origine=civicrm_1| id=4| type=don \u0026gt; Ceci est la balise minimale pour un formulaire de don. On y trouve l\u0026rsquo;identifiant de la campagne, ainsi que le système distant dont elle vient (dans le cas où votre installation utiliser plusieurs systèmes distants).\nCe formulaire se basera sur la configuration par défaut de votre installation (pour la liste des montants, etc).\nSi vous l\u0026rsquo;insérez dans un article, voilà ce que vous obtiendrez :\nPersonnalisation de la balise Vous pouvez cocher les différentes cases de l\u0026rsquo;utilitaire pour pouvoir personnaliser les différentes options :\nÀ chaque fois que vous cochez une option, un nouveau paramètre est ajouté dans la balise.\nCe paramètre reprend les valeurs par défaut de votre installation. Vous pourrez alors copier/coller la balise dans un article, puis ensuite changer les valeurs.\nDon / Adhésion / Objectif Les premiers boutons radio permettent de choisir le type de formulaire à utiliser :\nformulaire de don formulaire d\u0026rsquo;adhésion (qui permet également de faire un don additionnel) objectif (voir plus loin) Permettre les dons récurrents Si votre prestataire de paiement l\u0026rsquo;autorise, vous pouvez activer les dons récurrents sur le formulaire.\nActuellement Campagnodon ne gère que les dons mensuels.\nVoilà à quoi ressemble un formulaire de dons pour lequel les dons récurrents sont activés :\nLa personne est d\u0026rsquo;abord invitée à choisir si elle souhaite donner une seule fois ou plusieurs.\nNB: la liste des montants est différente pour les dons uniques et les dons récurrents.\nMontants personnalisés / Montant libre Par défaut, la liste des montants proposés est paramétrée sur le serveur. Vous pouvez toutefois changer la liste pour un formulaire donné.\nQuand vous cochez cette option, un attribut du type montants=30,50,70,libre est ajouté à la balise.\nQuand vous copierez cette balise dans votre article, vous pourrez alors modifier la liste des montants proposés.\nLa liste des montants est tout simplement une ligne de nombre séparés par des virgules (sans espace entre eux).\nVous pouvez ajouter la valeur spéciale libre à la liste des montants. Celle-ci à pour effet d\u0026rsquo;ajouter une option «montant libre» au formulaire. L\u0026rsquo;utilisateur⋅rice pourra alors saisir librement le montant voulu.\nIl existe une syntaxe avancée pour les montants :\nmontants=13[-450],21[450-900],35[900-1200],48[1200-1600],65[1600-2300],84[2300-3000],120[3000-4000],160[4000-] \u0026gt; Ici certains montants sont accompagnés de bornes entre crochets. Ces bornes servent à générer une phrase pouvant conditionner par exemple les valeurs à des niveaux de revenus :\nPersonnaliser les souscriptions optionnelles Les souscriptions optionnelles peuvent être personnalisées pour le formulaire.\nObjectif Si la campagne a un objectif de dons dans le système distant, alors vous aurez la possibilité de générer une balise campagnodon_objectif. En utilisant celle-ci dans un article, vous pourrez afficher une barre de progression.\nL\u0026rsquo;avancement de la campagne est raffraîchi toutes les heures, via le script de synchronisation des campagnes.\nSi vous souhaitez tester visuellement le rendu des bandeaux, ajoutez debug_objectif=1 aux paramètres de la balise. Vous aurez alors, en plus du bandeau de votre campagne, un rendu de différentes valeurs exemples.\nRédaction de l\u0026rsquo;article Vous n\u0026rsquo;avez plus qu\u0026rsquo;à coller la balise dans un article, puis éventuellement personnaliser les valeurs des attributs :\nVous pouvez bien sûr remplir l\u0026rsquo;article avec du texte avant et après la balise.\n"},{"uri":"https://johnxlivingston.github.io/campagnodon/fonctionnel/formulaires/","title":"Faire un don ou adhérer","tags":[],"description":"","content":"Une fois que vous avez publié un article utilisant une balise Campagnodon, voici comment cela se passe pour l\u0026rsquo;utilisateur⋅rice.\nFormulaire principal L\u0026rsquo;utilisateur⋅rice arrive sur un premier formulaire :\nLe formulaire varie légèrement en fonction de son type (don ou adhésion).\nPour faire un don, il est possible de ne fournir que son addresse email. Toutefois, si on coche la case «Je souhaite recevoir un reçu fiscal», il faudra alors préciser ses coordonnées :\nRèglement du don ou de l\u0026rsquo;adhésion Une fois ce premier formulaire passé, on arrive sur une page de paiement.\nCelle-ci est gérer par SPIP Bank, et son contenu dépendra donc de la configuration de votre module.\nIl est possible pour l\u0026rsquo;utilisateur⋅rice de revenir sur cette page plus tard pour finaliser le règlement. Il est également possible de paraméter dans le système distant (CiviCRM, \u0026hellip;) des relances par mail dans le cas où la personne ne serait pas allé au bout du processus de paiement.\n"},{"uri":"https://johnxlivingston.github.io/campagnodon/presentation/architecture/","title":"Architecture","tags":[],"description":"","content":"Principes de base Campagnodon est conçu de sorte à séparer:\nLe système d\u0026rsquo;origine: il s\u0026rsquo;agit du site public sur lequel les utilisateur⋅rice⋅s pourront effectuer des dons et adhésions Le système distant: il s\u0026rsquo;agit du backend dans lequel seront traités les données personnelles graph LR; Origine[Système d'origine] Distant[Système distant] Origine --\u003e Distant Distant -.-\u003e Origine À noter que les API utilisées pour communiquer entre les deux systèmes sont (quasiment) unidirectionnelles: en dehors d\u0026rsquo;un cas particulier (décrit plus loin), le système d\u0026rsquo;origine ne peut qu\u0026rsquo;alimenter le système distant, mais ne peut en extraire de donnée. Cela permet de compartimenter les données, et permet une meilleure sécurisation de celles-ci.\nCampagnodon a été originellement conçu pour:\nSPIP comme système d\u0026rsquo;origine CiviCRM comme système distant Toutefois, les API utilisées pour la communication sont standardisées, et il est tout à fait possible de changer le système d\u0026rsquo;origine et/ou le système distant.\nUn même système d\u0026rsquo;origine peut pointer vers plusieurs systèmes distants. Il n\u0026rsquo;y a pas forcément de cas d\u0026rsquo;usage précis pour cela, mais cela permet de simplifier un éventuel changement de système distant.\nFlux Dans le schéma ci-dessous, nous utiliserons SPIP comme système d\u0026rsquo;origine et CiviCRM comme système distant pour mieux illustrer.\nsequenceDiagram participant SPIP participant CiviCRM Note over SPIP: L'utilisateur⋅rice soumet le formulaire de don/adhésion SPIP -\u003e\u003e CiviCRM: Création d'une transaction Note over SPIP: Choix de la méthode de paiement SPIP --\u003e\u003e CiviCRM: Dans certains cas, le prestaire a besoin des données personnelles (DSP2) CiviCRM --\u003e\u003e SPIP: Renvoi des données personnelles, uniquement si la transaction est bien en cours Note over SPIP: Validation de la méthode de paiement loop Statut de la transaction mis à jour par SPIP Bank/le pretataire bancaire SPIP -\u003e\u003e CiviCRM: Mise à jour du statut de la transaction end En dehors du cas où le prestataire bancaire a besoin de données personnelles pour gérer le protocole DSP2 (voir la documentation de SPIP Bank), les API fonctionnent donc de manière uni-directionnelles: SPIP alimente CiviCRM, mais ne peut pas en extraire de donnée personnelle.\n"},{"uri":"https://johnxlivingston.github.io/campagnodon/fonctionnel/","title":"Documentation fonctionnelle","tags":[],"description":"","content":"Documentation fonctionnelle "},{"uri":"https://johnxlivingston.github.io/campagnodon/technique/","title":"Documentation technique","tags":[],"description":"","content":"Documentation technique "},{"uri":"https://johnxlivingston.github.io/campagnodon/presentation/licence/","title":"Licence","tags":[],"description":"","content":"Ce projet est sous licence AGPLv3 licence.\n"},{"uri":"https://johnxlivingston.github.io/campagnodon/limitations/","title":"Limitations connues","tags":[],"description":"","content":"SPIP Dépendances obsolètes Pour faciliter le développement de Campagnodon pour Attac France, nous avons figé certaines dépendances de plugins dans des versions obsolètes.\nDe plus, les squelettes ont été conçu pour bootstrap2 (qui est la version utilisée par Attac France).\nSi ces dépendances vous posent problèmes, ou si vous souhaitez utiliser une version plus récente de boostrap, n\u0026rsquo;hésitez pas à contacter l\u0026rsquo;auteur, par exemple via l\u0026rsquo;un des dépots listé dans le menu gauche.\nCiviCRM Droits d\u0026rsquo;accès et extensions tierces Les appels d\u0026rsquo;API effectués par Campagnodon sont fait avec des droits restreints. Si d\u0026rsquo;autres extensions CiviCRM utilisent des Hooks pour ajouter des actions spécifiques, il se peut que ces actions fassent échouer les appels d\u0026rsquo;API (ou est un comportement innatendu), à cause de droits manquants.\nPar exemple, si une extension essaie d\u0026rsquo;intercepter les changements d\u0026rsquo;adresse sur des contacts, pour par exemple ajouter des «relationship», cela risque d\u0026rsquo;échouer.\nActuellement la seule solution proposée est de modifier les extensions en question pour prendre en compte ce cas de figure. Par exemple en y désactivant le «check permission» des appels d\u0026rsquo;API CiviCRM v3 et v4.\n"},{"uri":"https://johnxlivingston.github.io/campagnodon/glossaire/","title":"Glossaire","tags":[],"description":"","content":"Le présent document explicite différents termes liés à Campagnodon.\nCampagne Une campagne de don et/ou d\u0026rsquo;adhésion permet de regrouper les dons et adhésions. Les campagnes sont à créer dans le système distant. Voir la documentation sur les campagnes.\nSouscriptions optionnelles Les soucriptions optionnelles sont des cases à cocher (en «opt-in») qui peuvent être ajoutées en fin de formulaire de don ou d\u0026rsquo;adhésion.\nVous pouvez par exemple ajouter des choix du type «m\u0026rsquo;inscrire à la newsletter», «j\u0026rsquo;accepte d\u0026rsquo;être démarché par téléphone», \u0026hellip;\nVous pouvez configurer un ensemble de souscriptions optionnelles au niveau du serveur (voir la documentation de configuration). Ces souscriptions pourront être utilisables sur les formulaires de don et/ou d\u0026rsquo;adhésion. Pourront être utilisée par défaut, ou optionnelle (à activer article par article).\nSystème distant Il s\u0026rsquo;agit du système qui contient la base de donnée des dons et adhésions.\nCampagnodon a été initialement créé pour utiliser CiviCRM comme système distant, mais on peut aisément adapter Campagnodon à d\u0026rsquo;autres systèmes distants.\nSi vous souhaitez utiliser Campagnodon avec autre chose que CiviCRM (ou même autre chose que SPIP), n\u0026rsquo;hésitez pas à contacter John Livingston. Vous pouvez par exemple passer par les gestionnaires de tickets de l\u0026rsquo;un des dépots de code référencé sur ce site web (voir dans le menu gauche).\nSystème d\u0026rsquo;origine Le système d\u0026rsquo;origine est le site public sur lequel des personnes peuvent réaliser des dons ou des adhésions.\nCampagnodon a été initialement créé pour utiliser SPIP comme système d\u0026rsquo;origine.\n"},{"uri":"https://johnxlivingston.github.io/campagnodon/categories/","title":"Categories","tags":[],"description":"","content":""},{"uri":"https://johnxlivingston.github.io/campagnodon/distant/civicrm/","title":"CiviCRM","tags":[],"description":"","content":"Le présent document indique comment installer un environnement de développement/test conforme à ce qu\u0026rsquo;utilise Attac.\nInstallation de CiviCRM CiviCRM\nbuildkit CiviCRM fourni l\u0026rsquo;outils buildkit qui met à disposition un ensemble d\u0026rsquo;outils pour faciliter le déploiement d\u0026rsquo;instances CiviCRM sur une machine de développement.\nLa première étape est donc d\u0026rsquo;installer buildkit sur la machine de développement (ou dans une machine virtuelle).\nPour cela, suivre la documentation d\u0026rsquo;installation de buildkit.\nDéployer une instance CiviCRM CiviCRM doit être associé à un CRM. Chez Attac, il s\u0026rsquo;agit de Drupal 7. À l\u0026rsquo;heure où cette documentation est écrite, CiviCRM est dans la version 5.47.\nOn peut aisément utiliser l\u0026rsquo;utilitaire civibuild pour créer une instance CiviCRM vierge. Pour cela, se placer dans le dossier où l\u0026rsquo;on a intallé buildkit, puis:\n./bin/civibuild create dev_attac --type drupal-clean --url http://127.0.0.1:9900 --civi-ver 5.47 Dans la ligne ci-dessus, on choisi d\u0026rsquo;installer CiviCRM sur localhost, et le rendre accessible via le port 9900. Adaptez ceci à votre situation.\nLes identifiants pour s\u0026rsquo;y connecter seront affiché dans la console.\nNote: ce type d\u0026rsquo;installation vient avec des données d\u0026rsquo;exemple.\nConfigurations spécifiques de CiviCRM Le mode de fonctionnement pour Attac suppose les configurations ci-dessous.\nActiver le composant «civicampaign» (Administrer \u0026gt; Paramètres système \u0026gt; Composants). Il faut activer l\u0026rsquo;extension php-curl sur le serveur qui fait tourner le système d\u0026rsquo;origine (SPIP). Il est possible d\u0026rsquo;utiliser le composant «CiviRules» pour envoyer des mails. Installer l\u0026rsquo;extension CiviCRM Campagnodon Allant de paire avec Campagnodon, il y a une Extension CiviCRM campagnodon-civicrm.\nPlacer les fichiers de l\u0026rsquo;extension dans le dossier des extensions du CiviCRM, puis aller dans l\u0026rsquo;interface d\u0026rsquo;administration Administrer \u0026gt; Paramètres système \u0026gt; Extension pour l\u0026rsquo;activer.\nIl faut ensuite obtenir des clés d\u0026rsquo;API CiviCRM, et les configurer coté SPIP. Pour obtenir les clés, on pourra par exemple installer l\u0026rsquo;extension API Key Management. Ensuite, aller sur la fiche contact de l\u0026rsquo;utilisateur admin qui servira (ce sont ses droits qui seront appliqués), ouvrir l\u0026rsquo;onglet «API Key», générer une nouvelle clé d\u0026rsquo;API. La clé de site, aussi nécessaire, est affichée sur le même écran.\n"},{"uri":"https://johnxlivingston.github.io/campagnodon/tags/","title":"Tags","tags":[],"description":"","content":""}]